---
title: 쿠버네티스입문 14장 볼륨
categories: ["Kubernetes", "Book"]
tags: ["K8S", "Kubernetes", "쿠버네티스 입문", "볼륨", "volume", "Book", "동양북스", "90가지 예제로 배우는 컨테이너 관리 자동화 표준"] 
toc: true
widgets:
  - type: toc
    position: right
sidebar:
  right:
    sticky: true
date: 2021-01-11 08:29:51
---

# 볼륨

데이터를 보존 해야 하는 경우 사용한다.

## 볼륨
- .spec.container.volumeMounts.mountPropagation
  - 볼륨을 공유할지 여부를 설정한다.
  - None : 호스트에서 볼륨에 해당하는 디렉터리 하위에 마운트한 다른 마운트들은 볼수 없다.
  - HostToContainer : 호스트에서 해당 볼륨 하위에 마운트된 다른 디렉터리들도 볼수 있다.
  - Bidirectional : 하위 마운트된 디렉토리를 볼수 있고 다른 모든 컨테이너나 파드에서 같은 볼륨을 사용할 수 있다.
- emptyDir
  - 호스트의 디스크를 임시로 컨테이너에 볼륨으로 할당
  - 파드가 사라지면 emptyDir 에 할당해서 사용했던 볼륨의 데이터도 사라진다
  - 설정
    ~~~
    spec:
      containers:
      - name: kubernetes-simple-pod
        image: arisu1000/simple-container-app:latest
        volumMounts:
        - mountPath: /emptydir
          name: emptydir-vol
      volumes:
      - name: emptydir-vol
        emptyDir: {}
    ~~~
    - 대부분 볼륨 설정과 마운트하는 부분이 분리되어있음.
- hostPath
  - 파드가 실행된 호스트의 파일이나 디렉토리 마운트
  - emptyDir VS hostPath
    ||emptyDir|hostPath|
    |---|---|---|
    ||임시디렉토리 마운트|실제디렉토리 마운트|
    ||컨테이너 재시작했을때 데이터 보존|파드 재시작했을때 데이터 보존|

  - 설정
    ~~~
    spec:
      containers:
      - name: kubernetes-simple-pod
        image: arisu1000/simple-container-app:latest
        volumMounts:
        - mountPath: /test-volume
          name: hostpath-vol
      volumes:
      - name: hostpath-vol
        hostPath:
          path: /tmp
          type: Directory
    ~~~
    - type 
      - DirectoryOrCreate : 디렉토리 없으면 퍼미션 755 로 디렉토리 생성
      - Directory : 해당 위치에 디렉토리 존재해야한다.
      - FileOrCreate : 파일 없으면 퍼미션 644로 파일 생성
      - File : 설정 경로에 파일이 있어야함.
      - Socket : 설정한 경로에 유닉스 소켓파일이 있어야함.
      - CharDevice : 설정한 경로에 문자 디파이스 있는지 확인.
      - BlockDevice : 설정한 경로에 블록 디바이스가 있는지 확인
- nfs
  - 기존에 사용하는 nfs 서버를 이용해서 파드에 마운트하는 것.
  - 여러개의 파드에 볼륨 하나를 공유해 읽기/쓰기 동시에 할때도 사용한다.

## PersistentVolume & PersistentVolumeClaim
- PV 는 볼륨 자체를 의미한다. 별도의 생명주기를 가지고 있다.
- PVC 는 사용자가 PV 에 하는 요청이다.
- PV 와 PVC 의 생명주기
  - 프로비저닝(Provisioning)
    - PV 를 만드는 단계
    - 정적 : 미리 적정 용량의 PV 를 만들어둠
    - 동적 : 사용자가 PVC 를 거쳐 PV를 요청했을때 생성
  - 바인딩(Binding)
    - PV 와 PVC 를 연결하는 단계
    - PV 와 PVC 는 1:1 관계이다
  - 사용(Using)
    - 할당된 PVC 는 시스템에서 임의로 삭제할 수 없다.
  - 반환(Reclaiming)
    - PVC 가 삭제되고 사용중인 PV를 초기화한다.
    - 반환정책
      - Retain 
        - PV 를 그대로 보존한다. PV를 삭제 하더라도 외부 연결된 스토리지는 그대로 남는다.
        - 재사용을 위해서는 PV를 삭제하고 스토리지에 남은 데이터를 직접 처리해줘야 한다.
      - Delete
        - PV 를 삭제하고 외부 스토리지의 볼륨도 삭제한다.
      - Recycle
        - PV의 데이터를 삭제하고 새로운 PVC 에서 PV 를 사용할 수 있도록 한다.
        - 중단 예정 정책
- PV 템플릿
  - 설정 
    ~~~
    apiVersion: v1
    kind: PersistentVolume
    metadata:
      name: pv-hostpath
    spec:
      capacity:
        storage: 2Gi
      volumeMode: Filesystem
      accessModes:
      - ReadWriteOnce
      storageClassName: manual
      persistentVolumeReclaimPolicy: Delete
      hostPath:
        path: /tmp/k8s-pv
    ~~~
    - .spec.volumeMode: 볼륨의 설정 상태. 기본은 Filesystem
    - .spec.accessModes: 읽기/쓰기 옵션
        - ReadWriteOnce: 노드 하나에만 읽기/쓰기로 마운트
        - ReadOnlyMany: 여러개 노드에 읽기 전용으로 마운트
        - ReadWriteMany: 여러개 노드에 읽기/쓰기로 마운트
        - 플러그인 별로 다름
    - .spec.stroageClassName: 스토리지 클래스 설정. 특정 스토리지 클래스가 있는 PV 는 해당 클래스에 맞는 PVC 와 연결 가능하다.
- PVC 템플릿
  - 설정
    ~~~
    apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: pvc-hostpath
    spec:
      volumeMode: Filesystem
      accessModes:
      - ReadWriteOnce
      storageClassName: manual
      resources:
        requests:
          storage: 1Gi          
    ~~~
    - .spec.resources.requests.storage: 필드 자원을 얼마나 사용할 것인지 요청. pv의 용량을 초과하면 안된다.
- pv, pvc 연결
  - label 로 연결
    ~~~
    pv
    ---
    metadata:
      name: pv-hostpath-label
      labels:
        location: local
    ---
    pvc
    ---
    spec:
      selector:
        matchLabels:
          location: local
    ~~~
  - 파드에서 사용
    ~~~
    spec:
      containers:
      - name: simple-app
        volumeMounts:
        - mountPath: "/tmp"
          name: myvolume
      volumes:
      - name: myvolume
        persistentVolumeClaim:
          claimName: pvc-hostpath
    ~~~
- pvc 크기 변경
  - .spec.storageClassName.allowVolumeExpansion : true 로 설정
  - 특정 볼륨 플러그인에 한해서만 가능
  - 파일시스템을 사용하는 파드라면 새로운 파드를 실행할때에만 진행된다