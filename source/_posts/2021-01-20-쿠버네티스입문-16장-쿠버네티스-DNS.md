---
title: 쿠버네티스입문 16장 쿠버네티스 DNS
categories: ["Kubernetes", "Book"]
tags: ["K8S", "Kubernetes", "쿠버네티스 입문", "DNS", "Book", "동양북스", "90가지 예제로 배우는 컨테이너 관리 자동화 표준"] 
toc: true
widgets:
  - type: toc
    position: right
sidebar:
  right:
    sticky: true
date: 2021-01-20 22:23:23
---

# 쿠버네티스 DNS

## 클러스터 안에서 도메인 사용하기

- 서비스 도메인 패턴 : 서비스이름.네임스페이스이름.svc.cluster.local
- 파드 도메인 패턴 : 파드ip주소.네임스페이스이름.pod.cluster.local
  - 파드 ip 주소는 -로 연결한다 (ex : 10.10.10.10 -> 10-10-10-10)
  - 10-10-10-10.default.pod.cluster.local
- .spec.template.spec.hostname 과 .spec.template.spec.subdomain 으로 설정한다. 
  - 파드의 도메인은 hostname.subdomain.네임스페이스이름.svc.cluster.local
  - pod.cluster.local 이 아닌 svc.cluster.local 이다
- dns 확인
  ~~~
  ➜  ~ k get po
  NAME                     READY   STATUS    RESTARTS   AGE
  myapp-74db4764fd-8jnnz   1/1     Running   0          66s
  ➜  ~ k exec myapp-74db4764fd-8jnnz nslookup appname.default-subdomain.default.svc.cluster.local
  kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.

  Name:      appname.default-subdomain.default.svc.cluster.local
  Address 1: 10.1.0.100 appname.default-subdomain.default.svc.cluster.local
  nslookup: can't resolve '(null)': Name does not resolve
  ➜  ~ k get po -o wide
  NAME                     READY   STATUS    RESTARTS   AGE     IP           NODE             NOMINATED NODE   READINESS GATES
  myapp-74db4764fd-8jnnz   1/1     Running   0          3m45s   10.1.0.100   docker-desktop   <none>           <none>
  ➜  ~ 
  ~~~

## DNS 질의 구조

- 파드마다 DNS를 어떤 순서로 질의할지 설정가능
- .spec.dnsPolicy 필드 사용
  - Default
  - ClusterFisrt
  - ClusterFisrtWithHostNet
  - None  
- kube-dns
  - kubedns, dnsmasq, sidecar 로 구성
  - kubedns 는 마스터를 보다가 엔드포인트 변경사항 발생시 메모리에 저장중인 DNS 데이터를 변경한다.
  - sidecar는 dnsmasq와 kubedns 헬스체크를 실행한다.
- CoreDNS
  ~~~
  ➜  ~ k describe configmap coredns -n kube-system
  Name:         coredns
  Namespace:    kube-system
  Labels:       <none>
  Annotations:  <none>

  Data
  ====
  Corefile:
  ----
  .:53 {
      errors
      health {
        lameduck 5s
      }
      ready
      kubernetes cluster.local in-addr.arpa ip6.arpa {
        pods insecure
        fallthrough in-addr.arpa ip6.arpa
        ttl 30
      }
      prometheus :9153
      forward . /etc/resolv.conf {
        max_concurrent 1000
      }
      cache 30
      loop
      reload
      loadbalance
  }
  ~~~