---
title: 쿠버네티스입문 13장 인증과 권한
categories: ["Kubernetes", "Book"]
tags: ["K8S", "Kubernetes", "쿠버네티스 입문", "파드스케줄링", "Book", "동양북스", "90가지 예제로 배우는 컨테이너 관리 자동화 표준"] 
toc: true
widgets:
  - type: toc
    position: right
sidebar:
  right:
    sticky: true
date: 2021-01-04 13:50:16
---

# 인증과 권한

## kubectl config
- ~/.kube/config 파일
  ~~~
  apiVersion: v1
  clusters:
  - cluster:
      certificate-authority-data: ~~
      server: https://10.0.1.7:6443
    name: kubernetes
  contexts:
  - context:
      cluster: kubernetes
      user: kubernetes-admin
    name: kubernetes-admin@kubernetes
  current-context: kubernetes-admin@kubernetes
  kind: Config
  preferences: {}
  users:
  - name: kubernetes-admin
    user:
      client-certificate-data: data
      client-key-data: key
  ~~~
  - cluster.server: 외부에서 접속할수 있는 정보
  - clusters[].name: 클러스터 이름
  - context.cluster: 접근할 클러스터
  - context.user: 클러스터에 접근할 사용자 그룹
  - contexts[].name: 컨텍스트 이름
  - users[]: 클러스터를 사용할 사용자 그룹
  - user.client-certificate-data: 클라이언트 인증에 필요한 해시값
  - user.client-key-data: 클라이언트 키 해시값

- token 조회 하기
  ~~~
  master01@master01-VirtualBox:~$ kubectl get sa default -o yaml
  apiVersion: v1
  kind: ServiceAccount
  metadata:
    creationTimestamp: "2020-10-12T10:21:28Z"
    name: default
    namespace: default
    resourceVersion: "395"
    selfLink: /api/v1/namespaces/default/serviceaccounts/default
    uid: 034e5b6a-0484-4aef-a78f-42a206032779
  secrets:
  - name: default-token-w5t42
  ~~~
  - default-token~이라는 secret확인 가능
  ~~~
  kubectl describe secret default-token-w5t42
  Name:         default-token-w5t42
  Namespace:    default
  Labels:       <none>
  Annotations:  kubernetes.io/service-account.name: default
                kubernetes.io/service-account.uid: 034e5b6a-0484-4aef-a78f-42a206032779

  Type:  kubernetes.io/service-account-token

  Data
  ====
  namespace:  7 bytes
  token:      eyJhbGciOiJSUzI1NiIsImtpZCI6ImNIV1I5a0MtZVUxUE1JY0RHY1lvRkJZZDN5M3o3TkxncWY3QUN3R0FGelkifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tdzV0NDIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjAzNGU1YjZhLTA0ODQtNGFlZi1hNzhmLTQyYTIwNjAzMjc3OSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.irtlJ4PmyJZ-5auePspxP4xd0yMF8_aAVQN3gWRBaWeCgkYlkOWgS13EfwyKQEoQai2uGtL751G0eo07-VBvR0nV6ith0knHw3Ji2nYBzt0BSVke7DpLu4T6m6uSeNIPhugZ3QAJxB73tNS2BoCXM4Hpwvz8gyrmBMzT2ce7905XP8mXJwYV1-MnwlZFngSrnG6cHAqA6u1B4DpGSjZ1viLe_HL0j4tHn4NCRTEkxnJcEiSz4pcr2Frb1K2ZXVyhWslPQeIdA5QWaJEVvUe0GQK1V1aHRhfSYHfmJlSM00iJmrwCiY-fFMxvDiT4PCjLAwj4Bdoqjt-WsL_FeNWBXQ
  ca.crt:     1066 bytes
  ~~~
  - 실제 토큰을 조회해 보면 위와 같다
  - 토큰은 사용자를 추가 할때 사용될 수 있다.


## 권한
- ABAC
  - 속성기반 권한 관리
  - 변경하려면 직접 마스터에 접속해 파일 변경후 apiserver 재시작해야한다.
- RBAC
  - 역할 기반 권한 관리
  - 사용자와 역할을 분리해서 선언후 바인딩한다.

- Role
  - 특정 API 나 자원 사용 권한들을 명시해둔 규칙의 집합
  - Role과 ClusterRole 이 있다
  - Role
    - 해당 롤이 속한 네임스페이스에만 적용된다.
    - 설정
      ~~~
      apiVersion: rbac.authorization.k8s.io/v1
      kind: Role
      metadata:
        namespace: default
        name: read-role
      rules:
      - apiGroups: [""]
        resources: ["pod"]
        verbs: ["get", "list"]
      ~~~  
      - apiGroups: 롤이 사용할 apiGroup 들
      - resouces: 접근할 수 있는 자원
      - verbs: 어떤 동작이 가능한지 (create, get, list, update, patch, delete, deletecollection)
      - rules[].resourcesNames: 특정 이름의 리소스에만 적용 가능하게 할 수 있다. (get, delete, update, patch 만 적용가능하다. 나머지는 개별 api 를 호출하는 verbs 가 아니기 때문이다)
  - ClusterRole
    - 설정은 Role 과 동일 하나 namespace 항목은 빠진다.
    - .aggregationRule 설정을 통해 다른 클러스터롤과 조합 가능
      ~~~
      aggregationRule:
        clusterRuleSelectors:
        - matchLabels:
            kubernetes.io/bootstrapping: rbac-defaults
      ~~~
      - rulese 를 설정 하지 않아도 다른 클러스터 롤에서 불러와서 적용한다.
    - 자원 뿐만 아니라 url 형태의 규칙도 추가 가능하며 verbs 는 get, post 만 사용 가능하다.
- RoleBinding
  - 롤과 사용자를 연결한다. RoleBinding, ClusterRoleBinding 이 있다.
  - RoleBinding
    - 설정
      ~~~
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: myuser
        namespace: default
      ---
      apiVersion: rbac.authorization/k8s.io/v1
      kind: RoleBinding
      metadata:
        name: read-rolebinding
        namespace: default
      subjects:
      - kind: ServiceAccount
        name: myuser
        apiGroup: ""
      roleRef:
        kind: Role
        name: read-role
        apiGroup: rbac.authorization.k8s.io
      ~~~
      - subjects[].apiGroup: "" 은 핵심  apiGroup으로 설정했다는 의미
      - roleRef 는 어떤 롤을 할당할 건지 설정
      - 롤바인딩에 설정한 네임스페이스에 한해서 가능
  - ClusterRoleBinding
    - 설정
      ~~~
      apiVersion: rbac.authorization/k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: read-clusterrolebinding
      subjects:
      - kind: ServiceAccount
        name: myuser
        namespace: default
        apiGroup: ""
      roleRef:
        kind: ClusterRole
        name: read-clusterrole
        apiGroup: rbac.authorization.k8s.io
      ~~~
      - 롤바인딩과 차이점은 .subjects[].kind: ServiceAccount, User, Group 을 설정가능. ServiceAccount, User 설정시에는 네임스페이스 필요함      
    
---

> 출처 : 쿠버네티스 입문 - 90가지 예제로 배우는 컨테이너 관리자 자동화 표준 (동양북스)